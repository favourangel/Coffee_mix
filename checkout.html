<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Coffee Mix</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="styles.css">
    <script src="https://kit.fontawesome.com/c26cd2166c.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unpkg.com/bs-brain@2.0.4/utilities/bsb-btn-circle/bsb-btn-circle.css">
    <link rel="stylesheet" href="https://unpkg.com/bs-brain@2.0.4/utilities/margin/margin.css">
    <link rel="stylesheet" href="https://unpkg.com/bs-brain@2.0.4/utilities/padding/padding.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lobster&family=Pacifico&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@1,700&family=Lobster&family=Pacifico&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@1,700&family=Lobster&family=Montserrat+Alternates:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Pacifico&display=swap');
        .invalid {
        border: 2px solid red;
        }
        .valid {
        border: 2px solid green;
        }
        .error-message {
        color: red;
        font-size: 0.9em;
        margin-top: 4px;
        display: none;
        }
        button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
        }
        .card-logos {
        display: flex;
        gap: 10px;
        margin-top: 5px;
        }
        .card-logos img {
        height: 30px;
        opacity: 0.3; /* grayed out by default */
        transition: opacity 0.3s ease;
        }
        .card-logos img.active {
        opacity: 1; /* highlight detected card */
        }
  </style>
</head>
<body class="checkout-page">
    <!--checkout navbar-->
    <div class="checkout-navbar border-bottom p-3 mb-3 bg-white shadow-sm d-flex align-items-center">
        <div class="checkout-backbtn">
            <button class="btn btn-link text-decoration-none" onclick="window.location.href='main.html'">
                <i class="fas fa-arrow-left"></i>
            </button>
        </div>
        <div class="checkout-title mx-auto">
         <h5 class="mb-0 text-center">Checkout</h5>
        </div>
    </div>
    <!--checkout navbar-->

    <!--checkout banner-->
    <section class="checkout-banner">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-12 col-md-10 col-lg-8">
                    <div class="card-checkoutbanner my-4">
                        <div class="card">
                            <img class="checkout-banner-img" src="./img3/cake.png" alt="checkout banner">
                        </div>
                    </div>
                    <div class="checkout-banner-text text-center mb-5">
                        <h1 class="checkout-banner-title">Time To Checkout</h1>
                        <p>Complete your purchase by providing your details and payment information. Thank you for choosing Coffee Mix!</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!--checkout banner-->

    <!--Checkout Steps-->
    <div class="checkout-progress">
        <div class="step completed" id="step-order">
            <div class="circle"></div>
            <div class="label">Order</div>
        </div>
        <div class="step" id="step-details">
            <div class="circle"></div>
            <div class="label">Customer Details</div>
        </div>
        <div class="step" id="step-payment">
            <div class="circle"></div>
            <div class="label">Payment</div>
        </div>
    </div>
    <!--Checkout Steps-->

    <!--Checkout-->
    <section class="checkout-section py-10 my-5">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <h3 class="mb-4">Personal Information</h3>

                    <!-- Order Summary -->
                    <div class="card-ordersummary mb-4">
                        <div class="card-header">
                            <h5 class="mb-5 text-center fw-bold">Order Summary</h5>
                        </div>
                        <div class="card-body">
                            <div class="cart-items-list" id="checkout-items">
                                <!-- Items will be loaded here -->
                            </div>
                            <div class="cart-total">
                                <span>Total:</span>
                                <span class="total-amount" id="checkout-total">$0.00</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <strong>Order Type:</strong>
                                <span id="order-type">Pickup</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <strong>Delivery Fee:</strong>
                                <span id="delivery-fee">$0.00</span>
                            </div>
                        </div>
                    </div>

                    <!-- Customer Details Form -->
                    <div class="card-customerform mb-4">
                        <div class="card-header">
                            <h5 class="mb-5 text-center fw-bold">Customer Details</h5>
                        </div>
                        <div class="card-body">
                            <form id="checkout-form">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="firstName" class="form-label">First Name</label>
                                        <input type="text" class="form-control" id="firstName" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="lastName" class="form-label">Last Name</label>
                                        <input type="text" class="form-control" id="lastName" required>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="email" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="email" required>
                                </div>
                                <div class="mb-3">
                                    <label for="phone" class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" id="phone" required>
                                </div>
                                <div id="address-section">
                                    <div class="mb-3">
                                        <label for="address" class="form-label">Delivery Address</label>
                                        <textarea class="form-control" id="address" rows="3" placeholder="Enter your full address"></textarea>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Payment Method -->
                    <form class="card-form mb-4">
                        <h5 class="mb-3">Payment Method</h5>
                        <div class="card-body">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="payment" id="cash" value="cash" checked>
                                <label class="form-check-label" for="cash">
                                    Cash on Delivery
                                </label>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="radio" name="payment" id="card" value="card">
                                <label class="form-check-label" for="card">
                                    Credit/Debit Card
                                </label>
                            </div>
                            <div id="card-details">
                                <div class="row">
                                    <div class="col-md-12 mb-3">
                                        <label for="cardNumber" class="form-label">Card Number</label>
                                        <input type="tel" id="card-number" class="form-control" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19" inputmode="numeric" autocomplete="cc-number" required>
                                        <div class="card-logos">
                                            <img id="visa-logo" src="https://upload.wikimedia.org/wikipedia/commons/5/5e/Visa_2014_logo_detail.png" alt="Visa">
                                            <img id="mc-logo" src="https://upload.wikimedia.org/wikipedia/commons/2/2a/Mastercard-logo.svg" alt="Mastercard">
                                            <img id="amex-logo" src="https://upload.wikimedia.org/wikipedia/commons/3/30/American_Express_logo_%282018%29.svg" alt="Amex">
                                            <img id="discover-logo" src="https://upload.wikimedia.org/wikipedia/commons/0/0a/Discover_Card_logo.svg" alt="Discover">
                                        </div>
                                        <div id="card-error" class="error-message">Invalid card number.</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="expiry" class="form-label">Expiry Date</label>
                                        <input type="text" class="form-control" id="expiry" placeholder="MM/YY" maxlength="7" autocomplete="cc-exp" required>
                                        <div id="expiry-error" class="error-message">Invalid or expired date.</div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="cvv" class="form-label">CVV</label>
                                        <input type="text" class="form-control" id="cvv" placeholder="123"  maxlength="4" autocomplete="cc-csc" required>
                                        <div id="cvv-error" class="error-message">Invalid CVV. Must be 3–4 digits.</div>
                                    </div>
                                </div>
                            </div>
                            <label class="checkbox-container">
                                <input type="checkbox" name="save-card" />
                                <span class="checkmark"></span>
                                Save this card
                            </label>
                        </div>
                    </form>

                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-center align-items-center mt-4">
                        <button type="button" class="btn btn-secondary btn-sm me-3" onclick="window.location.href='menu.html'">
                            <i class="fas fa-arrow-left me-2"></i>
                            Back to Menu
                        </button>
                        <button type="button" class="btn btn-success btn-sm" id="confirm-order">
                            <i class="fas fa-check me-2"></i>
                            Confirm Order
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!--Checkout-->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Load cart from localStorage
        const cart = JSON.parse(localStorage.getItem('checkoutCart') || '[]');
        const orderType = localStorage.getItem('orderType') || 'pickup';
        const checkoutItems = document.getElementById('checkout-items');
        const checkoutTotal = document.getElementById('checkout-total');
        const orderTypeEl = document.getElementById('order-type');
        const deliveryFeeEl = document.getElementById('delivery-fee');
        const addressSection = document.getElementById('address-section');
        const cardDetails = document.getElementById('card-details');

        const fmt = v => '$' + Number(v || 0).toFixed(2);

        function loadCheckout() {
            if (cart.length === 0) {
                checkoutItems.innerHTML = '<p class="text-center text-muted">No items in cart</p>';
                return;
            }

            let total = 0;
            cart.forEach(item => {
                const priceNum = Number(item.price) || 0;
                const itemTotal = priceNum * item.qty;
                total += itemTotal;

                const itemDiv = document.createElement('div');
                itemDiv.className = 'item';
                itemDiv.innerHTML = `
                    <div class="item-image">
                        <img src="${item.image || './img2/freepik__matcha-latte__2976-removebg-preview.png'}" alt="${item.name}" width="78" height="78">
                    </div>
                    <div class="item-details">
                        <h4 class="item-name">${item.name}</h4>
                        <h4 class="item-price">${fmt(itemTotal)}</h4>
                    </div>
                    <div class="flex">
                        <span class="quantity-value">${item.qty}</span>
                    </div>
                `;
                checkoutItems.appendChild(itemDiv);
            });

            const deliveryFee = orderType === 'delivery' ? 20 : 0;
            total += deliveryFee;

            orderTypeEl.textContent = orderType === 'delivery' ? 'Delivery' : 'Pickup';
            deliveryFeeEl.textContent = fmt(deliveryFee);
            checkoutTotal.textContent = fmt(total);

            // Show address section for delivery
            if (orderType === 'delivery') {
                addressSection.style.display = 'block';
            }
        }

        // Payment method toggle
        document.querySelectorAll('input[name="payment"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'card') {
                    cardDetails.style.display = 'block';
                } else {
                    cardDetails.style.display = 'none';
                }
            });
        });

        // Confirm order
        document.getElementById('confirm-order').addEventListener('click', function() {
            const form = document.getElementById('checkout-form');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // In a real app, this would submit to server
            alert('Order confirmed! Thank you for your purchase.');
            
            // Clear cart and redirect
            localStorage.removeItem('checkoutCart');
            localStorage.removeItem('orderType');
            window.location.href = 'main.html';
        });


        const cardInput = document.getElementById('card-number');
        const expiryInput = document.getElementById('expiry');
        const cvvInput = document.getElementById('cvv');
        const submitBtn = document.getElementById('submit-btn');

        const cardError = document.getElementById('card-error');
        const expiryError = document.getElementById('expiry-error');
        const cvvError = document.getElementById('cvv-error');

        const logos = {
            visa: document.getElementById('visa-logo'),
            mc: document.getElementById('mc-logo'),
            amex: document.getElementById('amex-logo'),
            discover: document.getElementById('discover-logo')
        };

        // Auto-format card number
        cardInput.addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            value = value.match(/.{1,4}/g)?.join(' ') || '';
            e.target.value = value;
            detectCardType(value.replace(/\s+/g, ''));
            validateForm();
        });

        // Detect card type by prefix
        function detectCardType(number) {
        Object.values(logos).forEach(logo => logo.classList.remove('active'));
        if (/^4/.test(number)) {
            logos.visa.classList.add('active');
        } else if (/^5[1-5]/.test(number)) {
            logos.mc.classList.add('active');
        } else if (/^3[47]/.test(number)) {
            logos.amex.classList.add('active');
        } else if (/^6(?:011|5)/.test(number)) {
            logos.discover.classList.add('active');
        }
        }

        // Luhn algorithm validation
        function isValidCardNumber(number) {
        number = number.replace(/\s+/g, '');
        let sum = 0;
        let shouldDouble = false;
        for (let i = number.length - 1; i >= 0; i--) {
            let digit = parseInt(number.charAt(i));
            if (shouldDouble) {
            digit *= 2;
            if (digit > 9) digit -= 9;
            }
            sum += digit;
            shouldDouble = !shouldDouble;
        }
        return (sum % 10) === 0;
        }

        // Expiry validation
        function isValidExpiry(value) {
        const [month, year] = value.split('/');
        if (!month || !year || isNaN(month) || isNaN(year)) return false;
        const expMonth = parseInt(month, 10);
        const expYear = parseInt(year, 10) + 2000;
        const now = new Date();
        const expiryDate = new Date(expYear, expMonth - 1);
        return expMonth >= 1 && expMonth <= 12 && expiryDate >= now;
        }

        // CVV validation
        function isValidCVV(value) {
        return /^\d{3,4}$/.test(value);
        }

        // Validate all fields and toggle button
        function validateForm() {
            let cardValid = isValidCardNumber(cardInput.value);
            let expiryValid = isValidExpiry(expiryInput.value);
            let cvvValid = isValidCVV(cvvInput.value);

            // Card
            if (!cardValid) {
                cardInput.classList.add('invalid');
                cardInput.classList.remove('valid');
                cardError.style.display = 'block';
            } else {
                cardInput.classList.add('valid');
                cardInput.classList.remove('invalid');
                cardError.style.display = 'none';
            }

            // Expiry
            if (!expiryValid) {
                expiryInput.classList.add('invalid');
                expiryInput.classList.remove('valid');
                expiryError.style.display = 'block';
            } else {
                expiryInput.classList.add('valid');
                expiryInput.classList.remove('invalid');
                expiryError.style.display = 'none';
            }

            // CVV
            if (!cvvValid) {
                cvvInput.classList.add('invalid');
                cvvInput.classList.remove('valid');
                cvvError.style.display = 'block';
            } else {
                cvvInput.classList.add('valid');
                cvvInput.classList.remove('invalid');
                cvvError.style.display = 'none';
            }

            // Enable/disable submit
            //submitBtn.disabled = !(cardValid && expiryValid && cvvValid);
        }

        // Live validation on input
        expiryInput.addEventListener('input', validateForm);
        cvvInput.addEventListener('input', validateForm);


        //opening card details if card payment is selected on load
        document.addEventListener("DOMContentLoaded", function() {
            const cardDetails = document.getElementById("card-details");
            const paymentRadios = document.querySelectorAll('input[name="payment"]');

            // Hide by default
            cardDetails.classList.remove("show");

            paymentRadios.forEach(radio => {
            radio.addEventListener("change", function() {
                if (this.value === "card") {
                cardDetails.classList.add("show");   // bounce slide in
                } else {
                cardDetails.classList.remove("show"); // collapse out
                }
            });
            });
        });

        //card checkbox save card design
        
        document.querySelector('input[name="save-card"]').addEventListener('change', function() {
            if (this.checked) {
                console.log("✅ User wants to save card");
                // Add your logic here, e.g. set a flag, call API, etc.
            } else {
                console.log("❌ User does not want to save card");
            }
        });



        // Load checkout on page load
        loadCheckout();

        //progress bar steps

        document.addEventListener("DOMContentLoaded", function() {
            const stepOrder = document.getElementById("step-order");
            const stepDetails = document.getElementById("step-details");
            const stepPayment = document.getElementById("step-payment");

            const formInputs = document.querySelectorAll("#checkout-form input, #checkout-form textarea");
            const paymentRadios = document.querySelectorAll('input[name="payment"]');

            // ✅ Step 1: Order is always complete
            stepOrder.classList.add("completed");
            stepOrder.querySelector(".circle").textContent = "✔";

            // ✅ Step 2: Customer Details
            formInputs.forEach(input => {
                input.addEventListener("input", function() {
                let allFilled = true;
                formInputs.forEach(f => {
                    if (f.hasAttribute("required") && !f.value.trim()) {
                    allFilled = false;
                    }
                });
                if (allFilled) {
                    stepDetails.classList.add("completed");
                    stepDetails.querySelector(".circle").textContent = "✔";
                } else {
                    stepDetails.classList.remove("completed");
                    stepDetails.querySelector(".circle").textContent = "";
                }
                });
            });

            // ✅ Step 3: Payment Method
            paymentRadios.forEach(radio => {
                radio.addEventListener("change", function() {
                if (this.checked) {
                    stepPayment.classList.add("completed");
                    stepPayment.querySelector(".circle").textContent = "✔";
                }
                });
            });
        });


    </script>
</body>
</html>

